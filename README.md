# Документация Project Practice API

## 1. Введение

Этот документ представляет собой документацию для бэкенд-приложения Project Practice API. Приложение разработано на Java
с использованием фреймворка Spring Boot. Его основная цель — управление жизненным циклом проектной практики, включая
обработку данных о компаниях, студентах, проектах, командах и связанных файлах (резюме, презентации, технические
задания). API предоставляет как GraphQL для запросов и изменения данных, так и REST-эндпоинты для специфических
операций, таких как аутентификация, обработка файлов и экспорт данных.

## 2. Используемые технологии

На основе `pom.xml` и исходного кода используются следующие ключевые технологии:

* **Java 17:** Основной язык программирования.
* **Spring Boot (v3.4.3):** Основной фреймворк приложения, упрощающий настройку и конфигурацию.
    * **Spring Web:** Используется для создания RESTful API (Controllers, RequestMapping и т.д.).
    * **Spring Data JPA:** Упрощает доступ к базе данных с использованием Java Persistence API (Repositories, Entities).
    * **Spring Security:** Обрабатывает аутентификацию (JWT) и авторизацию (управление доступом на основе ролей с
      использованием `@PreAuthorize`).
    * **Spring GraphQL:** Реализует GraphQL API (QueryMapping, MutationMapping).
    * **Spring Validation:** Используется для валидации входных DTO (`@Valid`, `@NotNull` и т.д.).
    * **Spring Kafka:** Обеспечивает асинхронную связь через Apache Kafka для задач, таких как отправка уведомлений по
      электронной почте при одобрении компании или создании проекта.
    * **Spring Cache:** Предоставляет возможности кэширования (например, кэширование списков проектов), потенциально с
      использованием Redis.
    * **Spring Boot Actuator:** Предоставляет готовые к продакшену функции, такие как проверка работоспособности (health
      checks) и метрики.
    * **Spring Mail:** Используется для отправки электронных писем (например, уведомлений о пароле).
* **PostgreSQL:** Реляционная база данных, используемая для хранения данных приложения (компании, студенты, проекты,
  команды).
* **Flyway:** Инструмент миграции базы данных, используемый для управления изменениями схемы БД с контролем версий.
* **Redis:** (Подразумевается из `spring-boot-starter-data-redis`) Вероятно, используется как провайдер распределенного
  кэша для Spring Cache.
* **MinIO:** S3-совместимое объектное хранилище, используемое для хранения загруженных файлов (резюме, презентации,
  технические задания). Библиотека `io.minio:minio` является клиентом для взаимодействия с ним.
* **Apache Kafka:** Распределенная потоковая платформа, используемая для разделения сервисов и обработки асинхронных
  событий (например, отправки электронных писем).
* **Lombok:** Библиотека для уменьшения шаблонного кода в Java-классах (например, `@Data`, `@Slf4j`,
  `@RequiredArgsConstructor`, `@FieldDefaults`).
* **MapStruct:** Генератор кода, упрощающий реализацию преобразований между типами Java bean (Entities <-> DTOs).
* **JJWT (Java JWT):** Библиотека, используемая для создания и проверки JSON Web Tokens (JWT) для аутентификации.
* **Springdoc OpenAPI (Swagger):** Генерирует интерактивную документацию API для REST-эндпоинтов, обычно доступную по
  адресу `/swagger-ui.html`.
* **Apache POI:** Библиотека Java, используемая для чтения и записи форматов файлов Microsoft Office, здесь конкретно
  для экспорта данных студентов в Excel (`.xlsx`).
* **Thymeleaf:** Серверный движок шаблонов Java, используемый для создания HTML-шаблонов электронных писем.
* **Maven:** Инструмент автоматизации сборки и управления зависимостями.

## 3. Обзор архитектуры

Приложение следует стандартной многоуровневой архитектуре:

* **Контроллеры (`controller` package):** Обрабатывают входящие HTTP-запросы (REST) и GraphQL-запросы/мутации. Они
  делегируют обработку сервисному уровню и управляют маппингом запросов/ответов и валидацией. REST-контроллеры
  используют `@RestController`, а GraphQL-контроллеры — `@Controller`.
* **Сервисы (`service` package):** Содержат основную бизнес-логику. Они взаимодействуют с репозиториями для доступа к
  данным, координируют различные операции и могут взаимодействовать с внешними системами (MinIO, Kafka, Email).
* **Хранилище (`store` package):**
    * **Сущности (`entity`):** JPA-сущности, представляющие таблицы базы данных.
    * **Репозитории (`repos`):** Интерфейсы Spring Data JPA для операций с базой данных.
    * **DTO (`dto`):** Data Transfer Objects, используемые для обмена данными между слоями и границами API. Включают
      входные DTO (`input` подпакет) для получения данных.
    * **Мапперы (`mapper`):** Интерфейсы MapStruct для преобразования между сущностями и DTO.
* **Конфигурация (`config` package):** Содержит конфигурационные классы для Spring Security, JWT, Kafka, потенциально
  клиента MinIO и т.д.
* **Исключения (`exceptions` package):** Пользовательские классы исключений (например, `NotFound`).

**Ключевые взаимодействия:**

* **Загрузка файлов:** Контроллеры получают `MultipartFile`, передают его соответствующему сервису (`ResumeService`,
  `PresentationService`, `TechnicalSpecificationsService`), который использует `FileValidateService` для валидации, а
  затем загружает файл в определенный бакет MinIO. Путь/имя файла сохраняется в соответствующей сущности (Student или
  Project).
* **Аутентификация:** `CompanyAuthController` обрабатывает запросы на вход, делегирует `CompanyService`, который
  использует `AuthenticationManager` из Spring Security и `JwtTokenUtils` для генерации токена при успешной
  аутентификации.
* **Авторизация:** Spring Security с аннотациями `@PreAuthorize` на методах контроллеров ограничивает доступ на основе
  ролей пользователей (ROLE\_ADMIN, ROLE\_COMPANY, ROLE\_STUDENT).
* **Асинхронные операции:** Определенные действия (одобрение компании, смена пароля, создание студенческого проекта)
  вызывают события, отправляемые в топики Kafka. `EmailService` слушает эти топики и отправляет электронные письма с
  использованием шаблонов Thymeleaf.
* **Экспорт данных:** `ExportController` использует `ExcelService` (который, в свою очередь, использует Apache POI) для
  генерации Excel-файла с данными студентов.

## 4. Эндпоинты API

### 4.1. GraphQL API (Доступ через `/graphql`)

#### Запросы (Queries)

* **`companies(): List<CompanyDto>`**
    * Описание: Получает список всех *одобренных* компаний.
    * Безопасность: Публичный (неявно, нет `@PreAuthorize`). *Примечание: Вероятно, должен быть защищен.*
* **`company(id: Long): CompanyDto`**
    * Описание: Получает конкретную компанию по ее ID.
    * Безопасность: Публичный (неявно). *Примечание: Вероятно, должен быть защищен.*
* **`unapprovedCompanies(): List<CompanyDto>`**
    * Описание: Получает список компаний, ожидающих одобрения.
    * Безопасность: Публичный (неявно). *Примечание: Вероятно, должен быть защищен, возможно, только для ADMIN.*
* **`projects(): List<ProjectDto>`**
    * Описание: Получает список всех проектов. Результаты могут кэшироваться.
    * Безопасность: Публичный (неявно).
* **`project(id: Long): ProjectDto`**
    * Описание: Получает конкретный проект по его ID.
    * Безопасность: Публичный (неявно).
* **`students(): List<StudentDto>`**
    * Описание: Получает список всех студентов.
    * Безопасность: Требуется роль `ROLE_ADMIN`, `ROLE_COMPANY` или `ROLE_STUDENT`. Требуется Bearer токен.
* **`student(id: Long): StudentDto`**
    * Описание: Получает конкретного студента по его ID.
    * Безопасность: Требуется роль `ROLE_ADMIN`, `ROLE_COMPANY` или `ROLE_STUDENT`. Требуется Bearer токен.
* **`teams(): List<TeamDto>`**
    * Описание: Получает список всех команд, отсортированных по имени.
    * Безопасность: Публичный (неявно).
* **`team(id: Long): TeamDto`**
    * Описание: Получает конкретную команду по ее ID.
    * Безопасность: Публичный (неявно).

#### Мутации (Mutations)

* **`createCompany(input: CompanyInputDto): CompanyDto`**
    * Описание: Создает новую регистрацию компании (требует одобрения). Валидирует входной DTO.
    * Вход: `CompanyInputDto` (содержит данные компании, такие как имя, email и т.д.).
    * Безопасность: Публичный.
* **`deleteCompany(id: Long): CompanyDto`**
    * Описание: Удаляет компанию по ее ID.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`deleteAllCompanies(): Void`**
    * Описание: Удаляет все компании, кроме компании администратора по умолчанию.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`createProject(input: ProjectInputDto): ProjectDto`**
    * Описание: Создает новый проект. Связывает его с компанией, выполняющей запрос (идентифицируется через JWT).
      Отправляет событие Kafka, если `isStudentProject` равно true. Инвалидирует кэш проектов. Валидирует входной DTO.
    * Вход: `ProjectInputDto` (содержит данные проекта).
    * Безопасность: Требуется роль `ROLE_ADMIN` или `ROLE_COMPANY`. Требуется Bearer токен (заголовок `Authorization`).
* **`deleteProject(id: Long): Void`**
    * Описание: Удаляет проект по его ID. Инвалидирует кэш проектов.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`deleteAllProjects(): Void`**
    * Описание: Удаляет все проекты. Инвалидирует кэш проектов.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`createStudent(input: StudentInputDto): StudentDto`**
    * Описание: Создает нового студента. Создает новую команду, если указанное `teamName` не существует, иначе назначает
      существующую или команду по умолчанию ("Не выбрана"). Валидирует входной DTO.
    * Вход: `StudentInputDto` (содержит данные студента).
    * Безопасность: Публичный.
* **`deleteStudent(id: Long): StudentDto`**
    * Описание: Удаляет студента по его ID.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`deleteAllStudents(): Void`**
    * Описание: Удаляет всех студентов.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`changeStudentTeam(teamId: Long): StudentDto`**
    * Описание: Изменяет команду для студента, выполняющего запрос (идентифицируется через JWT).
    * Вход: `teamId` (ID целевой команды).
    * Безопасность: Требуется роль `ROLE_ADMIN` или `ROLE_STUDENT`. Требуется Bearer токен (заголовок `Authorization`).
* **`deleteTeam(id: Long): TeamDto`**
    * Описание: Удаляет команду по ее ID. Переназначает студентов из удаленной команды в команду по умолчанию ("Не
      выбрана"). Нельзя удалить команду по умолчанию.
    * Безопасность: Публичный (неявно). *Примечание: Вероятно, должен быть защищен, возможно, только для ADMIN.*
* **`deleteAllTeams(): Void`**
    * Описание: Удаляет все команды, кроме команды по умолчанию ("Не выбрана"). Переназначает студентов в команду по
      умолчанию.
    * Безопасность: Публичный (неявно). *Примечание: Вероятно, должен быть защищен, возможно, только для ADMIN.*

### 4.2. REST API

#### Аутентификация и управление компаниями (`/company/*`)

* **`POST /company/login`**
    * Описание: Аутентифицирует пользователя компании по email и паролю.
    * Тело запроса: `CompanyLoginDto` (`{ "email": "...", "password": "..." }`).
    * Ответ: `200 OK` с `LoginAnswer` (`{ "token": "jwt_token" }`) при успехе, `401 Unauthorized` при неудаче.
    * Безопасность: Публичный.
* **`POST /company/approve?companyId={id}`**
    * Описание: Одобряет зарегистрированную компанию, генерирует пароль, сохраняет его (хэшированным) и отправляет
      событие Kafka (`company-password-email`) с сгенерированным паролем для уведомления по email.
    * Параметр запроса: `companyId` (ID компании для одобрения).
    * Ответ: `200 OK` при успехе.
    * Безопасность: Требуется роль `ROLE_ADMIN`. Требуется Bearer токен.
* **`POST /company/change-password?email={email}`**
    * Описание: Генерирует новый случайный пароль для компании, обновляет его в базе данных (хэшированным) и отправляет
      событие Kafka (`company-password-email`) для уведомления по email.
    * Параметр запроса: `email` (Email компании).
    * Ответ: `200 OK` при успехе.
    * Безопасность: Публичный.

#### Управление файлами (`api/v1/files/*`)

* **`GET /api/v1/files/resume/{fileName}`**
    * Описание: Загружает файл резюме по его имени из бакета `resume` MinIO.
    * Переменная пути: `fileName`.
    * Ответ: `200 OK` с файлом как `InputStreamResource` (`application/octet-stream`). `404 Not Found`, если файл не
      существует.
    * Безопасность: Публичный (неявно). *Примечание: Вероятно, должен быть защищен.*
* **`POST /api/v1/files/resume`**
    * Описание: Загружает файл резюме (`.pdf`, `.doc`, `.docx`, `.ppt`, `.pptx`) для конкретного пользователя.
      Валидирует ограничения файла. Генерирует структурир
